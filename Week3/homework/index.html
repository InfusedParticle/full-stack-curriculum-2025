<!DOCTYPE html>
<html>

<head>
	<title>Weather Complete</title>
	<meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<div id='main-container'>
		<div id='weather-container'>
			<h1 id="city-name" class="hidden">Austin, Texas</h1>
			<div id="temperature-container">
				<p id="temperature" class="hidden">92</p> <p id="degrees" class="hidden">째</p>
			</div>

			<div id="week-container">
			</div>
		</div> 
	</div>
	<div id='side-container'>
		<div>
			<input id='search-input' placeholder='search for a city'></input>
			<button id='search-button' onclick="search()">search</button>
		</div>
		<ul id='search-results-list'></ul>
	</div>
</body>

<script>
		// USE YOUR OWN API KEY
		const apiKey = "[redacted]";

        // variable that stores the city that is chosen
		let city;
        // variable that stores the weather and forecast for the city
		let weather;
        // the variable that stores the air quality index for the city
		let aqi;

		// function that accepts that a number N and returns the name of the day and the date N days from now as a string
		function formatDate(daysFromNow = 0) {
			let output = ''
			var date = new Date();
			date.setDate(date.getDate() + daysFromNow);
			output += date.toLocaleString('en-US', { weekday: 'long' }).toUpperCase()
			output += ' ' + date.getDate()
			return output
		}

		// function that uses OpenWeatherMap's geocoding API to find locations
		function search() {
			// takes the value from the search input
			let searchInput = document.querySelector("#search-input").value;
			if (searchInput) {
				// creates the API call with the value from the search input as a query
				let apiCall = `http://api.openweathermap.org/geo/1.0/direct?q=${searchInput},US&limit=5&appid=${apiKey}`;
				// calls the API
				fetch(apiCall)
					.then((response) => 
						// after recieving a response, take the response from the server and convert it to JSON 
						response.json()
					)
					.then((data) => {
						// after recieving the converted JSON data, pass the JSON to the renderSearchResults() function
						renderSearchResults(data)
					});
			}
		}

		// function that renders the search results as a unordered list
		function renderSearchResults(searchResults) {
				// selects the unordered list element search-results-list
				const ul = document.querySelector('#search-results-list')
				// shows the unordered list if was hidden previously
				ul.classList.remove("hidden");
				// clears out any list items from the previous search
				ul.innerHTML = ''
				// loops through each search result and creates and attaches a list item for the unordered list
				searchResults.forEach((searchResult, index) => {
					// creates a new unordered list element
					const li = document.createElement('li')
					// sets the list item's class as search-result
					li.setAttribute('class', 'search-result')
					// sets the text inside the list item as the name and state of the city 
					const fullName = searchResult.name + ', ' + searchResult.state
					li.innerHTML = fullName
					// if the list item of a city is clicked, call the selectCity() function
					li.addEventListener('click', () => selectCity(fullName, searchResult.name, searchResult.state, searchResult.lat, searchResult.lon))
					// attaches the list item elements to search-results-list
					ul.appendChild(li)
			})	
		}

		// function that is called whenever a city has been selected
		// HINT: think about what should be rendering on the screen whenever a city is selected and what information is needed to make that happen 
		function selectCity(fullName, name, state, lat, lon) {
			// hides the search-results-list since it is not needed right now
			document.querySelector('#search-results-list').className = 'hidden'
			// sets the global city variable
			document.querySelector("#search-input").value = ''
			city = {
				fullName: fullName,
				name: name,
				state: state,
				lat: lat,
				lon: lon
			}
			//printing the city object to the console
            // BEGIN CODING HERE
			let forecastApiCall = `http://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}`;
			fetch(forecastApiCall)
			.then(response => response.json())
			.then(data => renderForecastData(data))
			.catch(error => console.log(error));

			let weatherApiCall = `http://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}`;
			fetch(weatherApiCall)
			.then(response => response.json())
			.then(data => renderWeatherData(city, data))
			.catch(error => console.log(error));
		}

		function renderWeatherData(cityObject, data) {
			document.querySelector("#degrees").classList.remove("hidden");
			document.querySelector("#temperature").classList.remove("hidden");
			document.querySelector("#city-name").classList.remove("hidden");
			let currentTemp = data['main']['temp'];
			currentTemp = getFahrenheitFromKelvin(currentTemp);
			let cityString = cityObject['fullName'];
			setCurrentInfo(cityString, currentTemp);
		}

		function renderForecastData(data) {
			document.querySelector("#week-container").textContent = "";
			let curIndex = 0;
			let dayIndex = new Date().getDay();
			for(let i = 0; i < 5; i++) {
				let low = data['list'][curIndex]['main']['temp_min'];
				let high = data['list'][curIndex]['main']['temp_max'];
				let icon = data['list'][curIndex]['weather'][0]['icon'];
				for(let timestamp = 0; timestamp < 8; timestamp++) {
					let timestampData = data['list'][curIndex];
					let dateSeconds = new Date(timestampData['dt'] * 1000);
					let timestampHigh = timestampData['main']['temp_max'];
					let timestampLow = timestampData['main']['temp_min'];
					low = Math.min(low, timestampLow);
					high = Math.max(high, timestampHigh);
					curIndex++;
				}
				low = getFahrenheitFromKelvin(low);
				high = getFahrenheitFromKelvin(high);
				createDayContainer(dayIndex, low, high, `./icons/${icon}.svg`);
				dayIndex = (dayIndex + 1) % 7;
			}
		}

		function getFahrenheitFromKelvin(kelvins) {
			const celsius = kelvins - 273;
			const fahrenheit = Math.round(celsius * 1.8) + 32;
			return fahrenheit;
		}

		function setCurrentInfo(cityString, temperature) {
			const header = document.querySelector("#city-name");
			header.textContent = cityString;
			const temperatureString = document.querySelector("#temperature");
			temperatureString.textContent = temperature;
		}
		
		function createDayContainer(dayIndex, low, high, iconPath) {
			const degreeSymbol = "째";
			const week = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
			const day = week[dayIndex];

			let dayContainer = document.createElement("div");
			dayContainer.classList.add("day-container");

			let leftDay = document.createElement("div");
			leftDay.classList.add("left-day");
			dayContainer.appendChild(leftDay);

			let rightDay = document.createElement("div");
			rightDay.classList.add("right-day");
			dayContainer.appendChild(rightDay);

			let icon = document.createElement("img");
			icon.src = iconPath;
			icon.classList.add("weather-icon");
			leftDay.appendChild(icon);

			let dayText = document.createElement("h4");
			dayText.classList.add("day-text");
			dayText.innerText = day;
			leftDay.appendChild(dayText);

			let lowTemp = document.createElement("p");
			lowTemp.innerText = `${low}째`
			let line = document.createElement("div");
			line.classList.add("line");
			let highTemp = document.createElement("p");
			highTemp.innerText = `${high}째`
			rightDay.appendChild(lowTemp);
			rightDay.appendChild(line);
			rightDay.appendChild(highTemp);

			const weekContainer = document.querySelector("#week-container");
			weekContainer.appendChild(dayContainer);
		}
	</script>
</html>
